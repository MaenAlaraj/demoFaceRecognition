<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GC Mall 商品読み込みページ</title>
    <style>
        .auth-container {
             text-align: center;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 10px; /* Adjust as needed */
        }

        body {
            font-family: 'Arial', sans-serif;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            background-color: #007BFF;
            color: #FFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .scroll-container {
            width: 300px;
            height: calc(3 * (1.8em + 10px)); /* Assuming each item height is around 1.8em + padding/margin */
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .vertical{
            display: flex;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        li {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-item {
            background-color: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
        }

        #totalAmount {
            margin-top: 20px;
            font-size: 1.2em;
        }

        .animated-message {
            display: none;
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .animated-message.show {
            display: block;
            opacity: 1;
        }

        .animated-message.hide {
            opacity: 0;
        }
    </style>
</head>
<div class="auth-container" id="authContainer">
    <p>GC Mall デモアプリ</p>
    <p>GCのQRか顔を読み込ませてください</p>
    <div class="button-container">
        <button id="qrButton">QR</button>
        <button id="faceButton">顔</button>
    </div>
</div>

<body>
    <div id="mainContainer" style="display: none;">
        <p id="user"></p>
        <p id="message"></p>
        <button id="loadProduct">商品の読み込み</button>
        <div class="scroll-container">
            <ul id="productList">
                <li class="header-item">
                    <span>コード</span>
                    <span>商品名</span>
                    <span>値段</span>
                    <span>CAT.</span>
                    <span>日付</span>
                    <span>削除</span>
                </li>
            </ul>
        </div>
        <p id="Balance"></p>
        <div id="totalAmount">トータル: 0円</div>
        <div class="vertical">
            <button id="payment">支払い</button>
        </div>
    </div>

    <div id="animatedMessage" class="animated-message">Processing ....</div>

    <script>
        var showSecondSecreenFlg = true;
        var gckid = "";
        var prefix = "93929";
        var sbuser = prefix + "09000000013";
        const errorsSubstring = "エラー";
        var extractedUserID = "";
        var userBeforePrefix = "";
        const items = [];
        const gcMall_code = "09000000015";
        const header_prefix = "＆％MALL／";
        var total = 0;
        var AccountNo = "";
        var user = "";
        const payment_terminalID = "";
        var Balance;
        const Cat_List = {
            A: 6000,
            B: 10000,
            C: 5,
            D: 10000,
            E: 6000,
            F: 8000,
            G: 70000,
            H: 5000
        };

        function setBalance(userID) {
            userBeforePrefix = userID
            var user1 = prefix + userID
            var Balance_STR = CCWalletInterface.Balance(user1, payment_terminalID)
            var Balance_LIST = Balance_STR.split(" ")
            document.getElementById('message').innerText = "円残高:" + Balance_LIST[0].split(":")[1] + "円(残高の下限:" + Balance_LIST[1].split(":")[1] + "円)"
            Balance = parseInt(Balance_LIST[0].split(":")[1]) - parseInt(Balance_LIST[1].split(":")[1])
        }

        function setTotal() {
            total = 0;
            for (const item of items) {
                var price = item.price
                total += price;
            }
            document.getElementById('totalAmount').innerText = 'トータル: ' + total + "円";
        }

        function getValueFromCatList(category) {
            const key = category.trim();
            if (Cat_List.hasOwnProperty(key)) {
                return Cat_List[key];
            } else {
                return "商品のカテゴリーが見つかりません。";
            }
        }

        function removeItemsFromList() {
            const productList = document.getElementById('productList');
            const listItems = productList.querySelectorAll('li');
            listItems.forEach(listItem => {
                if (listItem.classList.contains('header-item')) {
                    return;
                }
                productList.removeChild(listItem);
            });
            items.length = 0;
            setTotal()
        }

        document.getElementById("faceButton").addEventListener("click", function() {
            try {
                var showSecondSecreenFlg = true;
                extractedUserID = "";
                var resultJsonString = FaceCaptureInterface.getFace("FaceCaptureInterface");
                const resultJsonObject = JSON.parse(resultJsonString);
                const facesArray = resultJsonObject.Faces;
                const numberOfFaces = facesArray.length;
                if (numberOfFaces === 0) {
                    message = "顔が検出されませんでしたので、再撮影してください。";
                    console.log(message);
                    setMessage(message, "show_message")
                } else if (numberOfFaces === 1) {
                    console.log("One face detected.");
                    const base64String = facesArray[0].image64;
                    console.log("Base64 string of the first face:", base64String);
                    setAnimatedMessage("Processing ....", true); // Show animated message
                    var info = CCWalletInterface.SearchFaces(sbuser, gckid, "S", base64String);
                    if (info.includes(errorsSubstring)) {
                        var qrstring = QRInterface.get_QRInfo("QR");
                        if (qrstring !== "Scanner stopped") {
                            var qrstr_list = qrstring.split(",");
                            var numFlg = checkValueInQrstrList(qrstr_list[1]);
                            const match = qrstring.match(/,(.*?),/);
                            extractedUserID = match ? match[1] : null;
                            if (extractedUserID !== null && numFlg == true) {
                                extractedUserID = prefix + extractedUserID;
                                var addFaceInfo = CCWalletInterface.AddFaces(sbuser, extractedUserID, "A", base64String);
                                if (addFaceInfo.includes(errorsSubstring)) {
                                    message = "QRコードから抽出された情報が既に登録されたので顔が登録されませんでした。";
                                    setMessage(message, "show_message");
                                    showSecondSecreenFlg = false;
                                } else {
                                    message = "顔が登録されました。";
                                    setMessage(message, "show_message");
                                    info = CCWalletInterface.SearchFaces(sbuser, gckid, "S", base64String);
                                }
                            } else {
                                message = "GC MAllのユーザーQR【識別番号・利用券番・利用者名】をご利用ください。";
                                setMessage(message, "show_message");
                                showSecondSecreenFlg = false;
                            }
                        } else {
                            showSecondSecreenFlg = false;
                        }
                    }
                    if (showSecondSecreenFlg !== false) {
                        setAnimatedMessage("", false); // Hide animated message
                        var CCW_FaceResponse_LIST = info.split("：");
                        var userID = CCW_FaceResponse_LIST[1].trim().replace('ユーザーID', '');
                        setBalance(userID);
                        removeItemsFromList();
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                    }
                } else {
                    message = "複数の顔が検出されましたので、再撮影してください。";
                    setMessage(message, "show_message");
                }
            } catch (error) {
                message = "エラーが発生しました。再試行してください。" + error.message;
                console.error("An error occurred:", error);
                setMessage(message, "show_message");
            } finally {
                setAnimatedMessage("", false); // Hide animated message
            }
        });

        function setMessage(message, displayID) {
            document.getElementById(displayID).innerText = message;
            console.log(message);
        }

        function setAnimatedMessage(message, show) {
            const animatedMessage = document.getElementById("animatedMessage");
            animatedMessage.innerText = message;
            if (show) {
                animatedMessage.classList.add("show");
                animatedMessage.classList.remove("hide");
            } else {
                animatedMessage.classList.remove("show");
                animatedMessage.classList.add("hide");
                setTimeout(() => {
                    animatedMessage.style.display = "none";
                }, 500);
            }
        }
    </script>
</body>
</html>
